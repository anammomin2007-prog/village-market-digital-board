<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin - Manage Orders</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial; padding:18px; background:#fbfcfe;}
    .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06); max-width:1100px;margin:8px auto;}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    .accept{background:#2e7d32;color:white;padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
    .reject{background:#c62828;color:white;padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
    .loginRow{display:flex; gap:8px; align-items:center}
  </style>
</head>
<body>

<div class="card">
  <h2>Admin - Orders</h2>
  <div id="loginBlock" class="card">
    <div id="adminSignedOut">
      <div class="loginRow">
        <input id="adminEmail" placeholder="admin email" />
        <input id="adminPass" type="password" placeholder="password" />
        <button id="loginBtn">Login</button>
      </div>
      <p class="small">Admin accounts must be added by project owner in Firebase Auth, then admin UID added to Firestore `admins` collection.</p>
    </div>
    <div id="adminSignedIn" style="display:none;">
      <button id="btnLogout">Logout</button>
    </div>
  </div>

  <div id="ordersBlock" class="card" style="display:none;">
    <h3>All Orders</h3>
    <table id="ordersTable">
      <thead><tr><th>Order ID</th><th>User</th><th>Category</th><th>Items</th><th>Total</th><th>Created</th><th>Status</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCcqror4oDL002_eM_YGfqnixUXYMucq80",
    authDomain: "village-market-digital-board.firebaseapp.com",
    projectId: "village-market-digital-board",
    storageBucket: "village-market-digital-board.appspot.com",
    messagingSenderId: "566562274208",
    appId: "1:566562274208:web:c94cd4d12999a9e99902c5",
    measurementId: "G-CX1Q8EP104"
};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI refs
  const loginBtn = document.getElementById('loginBtn');
  const adminEmail = document.getElementById('adminEmail');
  const adminPass = document.getElementById('adminPass');
  const ordersTableBody = document.querySelector('#ordersTable tbody');
  const ordersBlock = document.getElementById('ordersBlock');
  const adminSignedIn = document.getElementById('adminSignedIn');
  const adminSignedOut = document.getElementById('adminSignedOut');
  const btnLogout = document.getElementById('btnLogout');

  loginBtn.onclick = async () => {
    try {
      const res = await auth.signInWithEmailAndPassword(adminEmail.value, adminPass.value);
      const uid = res.user.uid;
      // verify in admins collection
      const adminDoc = await db.collection('admins').doc(uid).get();
      if(!adminDoc.exists){
        alert('Not an admin. Please ask the project owner to add your UID to admins collection.');
        auth.signOut();
        return;
      }
      adminSignedOut.style.display = 'none';
      adminSignedIn.style.display = 'block';
      ordersBlock.style.display = 'block';
      startOrdersListener();
    } catch(e) {
      alert('Login error: '+e.message);
    }
  };

  btnLogout.onclick = () => auth.signOut().then(()=> location.reload());

  let unsubscribe = null;
  function startOrdersListener(){
    if(unsubscribe) unsubscribe();
    unsubscribe = db.collection('orders').orderBy('createdAt','desc').onSnapshot(snapshot=>{
      ordersTableBody.innerHTML = '';
      snapshot.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        const created = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : '';
        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${d.name} <br>(${d.email})</td>
          <td>${d.category || '-'}</td>
          <td>${(d.items||[]).map(i=>i.raw||i.name).join('<br>')}</td>
          <td>${d.total || '-'}</td>
          <td>${created}</td>
          <td>${d.status}</td>
          <td>
            <button class="accept" data-id="${doc.id}">Accept</button>
            <button class="reject" data-id="${doc.id}">Reject</button>
            <button class="complete" data-id="${doc.id}">Complete</button>
          </td>
        `;
        ordersTableBody.appendChild(tr);
      });

      // attach event handlers
      document.querySelectorAll('.accept').forEach(b=>{
        b.onclick = async (e) => {
          const id = e.target.dataset.id;
          await db.collection('orders').doc(id).update({
            status:'accepted',
            acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Accepted ' + id);
        };
      });
      document.querySelectorAll('.reject').forEach(b=>{
        b.onclick = async (e) => {
          const id = e.target.dataset.id;
          await db.collection('orders').doc(id).update({ status:'rejected' });
          alert('Rejected ' + id);
        };
      });
      document.querySelectorAll('.complete').forEach(b=>{
        b.onclick = async (e) => {
          const id = e.target.dataset.id;
          await db.collection('orders').doc(id).update({ status:'completed' });
          alert('Completed ' + id);
        };
      });
    });
  }
</script>

</body>
</html>


